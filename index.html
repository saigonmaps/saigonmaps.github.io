<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saigon Maps</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link
      href="https://unpkg.com/maplibre-gl@^5.9.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@^5.9.0/dist/maplibre-gl.js"></script>
    <style>
      html,
      body,
      #map {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      .layer-switcher {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 6px;
        border-radius: 8px;
        border: 1px solid #ccc;
        z-index: 1000;
      }
      .layer-switcher select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        border: none;
        background: none;
        font-size: 16px;
        outline: none;
        cursor: pointer;
        color: #000;
      }
      #opacity-slider {
        position: absolute;
        z-index: 1001;
        right: -40px;
        top: 50%;
        width: 140px;
        height: 48px;
        background: transparent;
        transform: translateY(-50%) rotate(-90deg);
        transform-origin: center;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="layer-switcher">
      <select id="layer-select"></select>
    </div>
    <div id="opacity-slider-wrapper">
      <input
        type="range"
        id="opacity-slider"
        min="0"
        max="1"
        step="0.01"
        value="0.7"
        aria-label="opacity"
      />
    </div>

    <script>
      const mapData = [
        // {
        //   year: "1799",
        //   title: "1799",
        //   extent: [
        //     106.66310974197486, 10.7284089078892, 106.73408348814192,
        //     10.81907477618158,
        //   ],
        //   minzoom: 14,
        //   maxzoom: 16,
        // },
        // {
        //   year: "1815",
        //   title: "1815",
        //   extent: [
        //     106.59253020971416, 10.67480438985431, 106.77321160772257,
        //     10.85874723887189,
        //   ],
        //   minzoom: 11,
        //   maxzoom: 14,
        // },
        // {
        //   year: "1862",
        //   title: "1862",
        //   extent: [
        //     106.64132477338973, 10.73545757831537, 106.72678662505898,
        //     10.80610368051969,
        //   ],
        //   minzoom: 13,
        //   maxzoom: 15,
        // },
        // {
        //   year: "1882",
        //   title: "1882",
        //   extent: [
        //     106.59928568481523, 10.72414747108366, 106.81506752874711,
        //     10.85883495304312,
        //   ],
        //   minzoom: 11,
        //   maxzoom: 15,
        // },
        {
          year: "1882sg",
          title: "1882",
          extent: [
            106.68790889761982, 10.75992491777953, 106.7154731702806,
            10.79661345412525,
          ],
          minzoom: 14,
          maxzoom: 17,
        },
        {
          year: "1895",
          title: "1895",
          extent: [
            106.59965267658448, 10.72154007122158, 106.8137215222058,
            10.8640247908287,
          ],
          minzoom: 11,
          maxzoom: 16,
        },
        {
          year: "1898",
          title: "1898",
          extent: [
            106.6759312665849, 10.75495973984564, 106.72427647281555,
            10.7993229329022,
          ],
          minzoom: 13,
          maxzoom: 17,
        },
        // {
        //   year: "1900",
        //   title: "1900",
        //   extent: [
        //     106.57327249958398, 10.60595668250793, 106.82006490173511,
        //     10.91066587345636,
        //   ],
        //   minzoom: 11,
        //   maxzoom: 14,
        // },
        {
          year: "1923",
          title: "1923",
          extent: [
            106.60932966301338, 10.69839135437193, 106.73449223293163,
            10.80780587479193,
          ],
          minzoom: 12,
          maxzoom: 16,
        },
        // {
        //   year: "1930",
        //   title: "1930",
        //   extent: [
        //     106.32256496165391, 10.26361204686945, 107.02185113363315,
        //     11.22041807249264,
        //   ],
        //   minzoom: 10,
        //   maxzoom: 12,
        // },
        {
          year: "1942",
          title: "1942",
          extent: [
            106.61551471377386, 10.70758280467707, 106.7288180372704,
            10.79874044206949,
          ],
          minzoom: 12,
          maxzoom: 16,
        },
        {
          year: "1959",
          title: "1959",
          extent: [
            106.6073757281536, 10.71160133561969, 106.73215159431079,
            10.80635664553785,
          ],
          minzoom: 12,
          maxzoom: 15,
        },
        {
          year: "1968",
          title: "1968",
          extent: [
            106.61114334383667, 10.69549595671106, 106.73618676227112,
            10.84797186105234,
          ],
          minzoom: 12,
          maxzoom: 16,
        },
        // {
        //   year: "1984",
        //   title: "1984",
        //   extent: [
        //     106.48794823108798, 10.64493965784099, 106.7544499799539,
        //     10.88342721996651,
        //   ],
        //   minzoom: 11,
        //   maxzoom: 14,
        // },
      ];
      const apiKey = "8fJUltqQeAw6r7G62Ptd";
      const minZoomLevel = 12;

      const layerSelect = document.getElementById("layer-select");
      const opacitySlider = document.getElementById("opacity-slider");
      let symbolLayerIds = [];

      const map = new maplibregl.Map({
        container: "map",
        style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${apiKey}`,
        center: [106.6953, 10.7769],
        zoom: mapData[0].minzoom,
        maxBounds: [
          [106.5, 10.6],
          [107.0, 10.9],
        ],
        attributionControl: false,
      });

      mapData.forEach((data) => {
        const option = document.createElement("option");
        option.value = data.year;
        option.textContent = data.title;
        layerSelect.appendChild(option);
      });

      map.on("load", () => {
        const firstSymbolId = map
          .getStyle()
          .layers.find((l) => l.type === "symbol")?.id;

        symbolLayerIds = map
          .getStyle()
          .layers.filter((layer) => layer.type === "symbol")
          .map((layer) => layer.id);

        mapData.forEach((data, index) => {
          const layerId = `historic-${data.year}`;
          map.addSource(layerId, {
            type: "raster",
            tiles: [`/tiles/${data.year}/{z}/{x}/{y}.webp`],
            scheme: "tms",
            tileSize: 256,
            minzoom: data.minzoom,
            maxzoom: data.maxzoom,
            bounds: data.extent,
          });

          map.addLayer(
            {
              id: layerId,
              type: "raster",
              source: layerId,
              paint: {
                "raster-opacity": parseFloat(opacitySlider.value),
              },
              layout: {
                visibility: index === 0 ? "visible" : "none",
              },
            },
            firstSymbolId
          );
        });

        modifyBaseStyle(map);

        if (mapData.length > 0) {
          map.fitBounds(mapData[0].extent, {
            padding: 50,
            duration: 0,
          });
        }

        map.addControl(
          new maplibregl.NavigationControl({ showCompass: false }),
          "top-left"
        );
        map.addControl(
          new maplibregl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserHeading: true,
          }),
          "top-left"
        );

        map.addControl(
          new maplibregl.AttributionControl({
            customAttribution:
              '<a href="https://threads.com/@tomeyinhanoi" target="_blank">By Tomey</a>',
            compact: true,
          }),
          "bottom-left"
        );
      });

      // Styling
      function modifyBaseStyle(map) {
        // console.log(
        //   "All layer ids: ",
        //   map.getStyle().layers.map((layer) => layer.id)
        // );
        const layersToRecolor = ["Grass", "Meadow", "Forest", "Wood", "Scrub"];
        const layersToHide = [
          "Residential",
          "Industrial",
          "Other border",
          "Disputed border",
        ];
        const pathsToRecolor = ["Path", "Path minor"];

        const applyProperty = (layerIds, type, key, value) => {
          layerIds.forEach((id) => {
            if (map.getLayer(id)) {
              if (type === "paint") map.setPaintProperty(id, key, value);
              if (type === "layout") map.setLayoutProperty(id, key, value);
            }
          });
        };

        applyProperty(layersToRecolor, "paint", "fill-color", "#A1E8A1");
        applyProperty(layersToHide, "layout", "visibility", "none");
        applyProperty(pathsToRecolor, "paint", "line-color", "#efeeef");

        if (map.getLayer("Building") || map.getLayer("Building 3D")) {
          map.setLayerZoomRange("Building", 16, 24);
          map.setLayerZoomRange("Building 3D", 16, 24);
        }
      }

      // Dropdown
      function changeHistoricLayer() {
        const selectedYear = layerSelect.value;

        mapData.forEach((data) => {
          const layerId = `historic-${data.year}`;
          const visibility = data.year === selectedYear ? "visible" : "none";
          if (map.getLayer(layerId)) {
            map.setLayoutProperty(layerId, "visibility", visibility);
          }
        });

        const selectedMap = mapData.find((data) => data.year === selectedYear);
        if (selectedMap) {
          map.fitBounds(selectedMap.extent, {
            padding: 50,
          });
        }
      }

      // Opacity slider
      function changeOpacity() {
        const opacity = parseFloat(opacitySlider.value);
        mapData.forEach((data) => {
          const layerId = `historic-${data.year}`;
          if (map.getLayer(layerId)) {
            map.setPaintProperty(layerId, "raster-opacity", opacity);
          }
        });

        const newVisibility = opacity >= 0.6 ? "none" : "visible";
        symbolLayerIds.forEach((id) => {
          map.setLayoutProperty(id, "visibility", newVisibility);
        });
      }

      layerSelect.addEventListener("change", changeHistoricLayer);
      opacitySlider.addEventListener("input", changeOpacity);
    </script>
    <script>
      // Service worker for caching
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((registration) => {
              console.log("Service Worker registered for caching.");
            })
            .catch((error) => {
              console.error("Service Worker registration failed:", error);
            });
        });
      }
    </script>
  </body>
</html>
